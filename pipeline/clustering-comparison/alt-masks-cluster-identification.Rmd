---
title: "Alternative masks cluster assignment"
author: "Michael Geuenich"
date: "June 7, 2020"
output: html_document
params:
  cells: "output/squirrel/sces/schapiro_alt-Cy1x8_35-Schulz-sce.rds"
  csvs: "output/squirrel/results/alternative_masks/Phenograph_clusters_Cy1x8_35-Schulz_specified_markers_k50.csv"
  markers_list: "markers/schapiro-markers.yml"
  core: "Cy1x8_35"
  user: "Schulz"
  method: ""
  markers: ""
  cluster: ""
  output_dir: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/imc-2020/')
library(tidyverse)
library(cowplot)
library(ComplexHeatmap)
library(SingleCellExperiment)
library(yaml)
library(GSVA)
library(pheatmap)
devtools::load_all('~/taproom/')
```

```{r}
# Read in markers
markers <- read_markers(params$markers_list)

# Read in RDS file
sce <- readRDS(params$cells)

# Read in clustering results
clustering_df <- read_csv(params$csvs) %>% column_to_rownames("id")
names(clustering_df)[1] <- "cluster"

# Add cell types to sce
sce$cluster <- clustering_df[colnames(sce),]$cluster
```


Gene set enrichment analysis
```{r}
gsva <- gsva(logcounts(sce),
          markers$cell_types,
          method="gsva")

df_gsva <- t(gsva) %>% 
  as.data.frame() %>% 
  rownames_to_column("id") %>% 
  gather(pathway, score, -id) %>% 
  as_tibble()
```


```{r message=F}
clustering_df <- clustering_df %>% rownames_to_column("id")

cluster_cell_type_scores <- inner_join(df_gsva, clustering_df) %>% 
  group_by(pathway, cluster) %>% 
  summarize(mean_score = mean(score)) %>% 
  ungroup() %>% 
  group_by(pathway) %>% 
  mutate(mean_score = (mean_score - mean(mean_score)) / sd(mean_score)) %>% 
  ungroup() %>% 
  group_by(cluster) %>% 
  mutate(thresh_score = mean_score == max(mean_score)) %>% 
  filter(thresh_score == TRUE)


cell_assignments <- inner_join(clustering_df, cluster_cell_type_scores) %>% 
  select(-c(mean_score, thresh_score)) %>% 
  dplyr::rename("cell type" = "pathway")

cell_assignments$origin <- paste(params$core, "-", params$user)


write.csv(cell_assignments, file = paste0(params$output_dir, "Alternative_masks-",
                                          params$method, "-cell_type_assignments-",
                                          params$core, "-", params$user, "-", 
                                          params$markers, "-", params$cluster, ".csv"),
          quote = FALSE, row.names = FALSE)

```