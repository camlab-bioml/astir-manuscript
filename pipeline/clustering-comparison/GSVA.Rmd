---
title: "GSVA"
author: "Michael Geuenich"
date: "August 11, 2020"
output: html_document
params:
  cells: ""
  markers: ""
  csvs: ""
  cohort: ""
  markers_rem: ""
  output: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../../')
library(devtools)
library(SingleCellExperiment)
library(scater)
library(tidyverse)
library(GSVA)
library(ggalluvial)
library(taproom)
source("../../scripts/functions.R")
#devtools::load_all("../../../taproom/")
```

Read in data
```{r}
cells <- readRDS(params$cells)
markers <- params$markers %>% read_markers()
markers <- markers$cell_types
csvs <- params$csvs
cohort <- params$cohort
markers_rem <- params$markers_rem
output_dir <- params$output

file <- read_csv(csvs)
names(file)[2] <- "cluster"
file$cluster <- as.character(file$cluster)
file$method <- paste0(file$method, "-", file$params)
file$params <- NULL


markers_remove <- unlist(strsplit(markers_rem, split = "-"))
```

GSVA
```{r}
final_markers <- list(cell_types = markers[!names(markers) %in% markers_remove])

expression_mat <- logcounts(cells) %>% 
  t() %>% 
  as_tibble() %>% 
  mutate(id = colnames(cells))

expression_mat <- expression_mat %>% 
  left_join(select(file, id, cluster)) %>% 
  select(-id)

assignments <- assign_clusters(expression_mat, final_markers)
assigned <- assignments$assignment
aggregated_expression <- assignments$expression

if(is.null(assigned)){
  assigned_clustering <- file
  assigned_clustering$GSVA_cell_type <- NA
}else{
  assigned_clustering <- left_join(file, select(assigned, cluster, GSVA_cell_type))
}
```

```{r}
if(nrow(aggregated_expression) > 1){
  manual_annotation <- manual_cluster_assignment(assignments$expression, final_markers)

  assigned_clustering <- left_join(assigned_clustering, manual_annotation)
}else{
  assigned_clustering$Manual_cell_type <- NA
}
```

```{r}
assigned_clustering$condition <- paste(markers_remove, collapse = "-")
# method <- unique(file$method)

# if(cohort == "basel" & grepl('specified', csvs) & grepl('ClusterX', csvs)){
#   method <- "ClusterX-specified_markers_default"
# }

# split_one <- strsplit(method[1], "-")
# split_two <- strsplit(split_one[[1]][2], "_")

# write_csv(assigned_clustering, paste0(output_dir, "GSVA-Other-methods-robustness_", cohort, "_", split_one[[1]][1], "_", 
#                                       paste0(tolower(split_two[[1]][3]), split_two[[1]][4]), "_", 
#                                       paste(split_two[[1]][1:2], collapse = "-"), "_", paste(markers_remove, collapse = "-"), ".csv"))

write_csv(assigned_clustering, output_dir)
```

