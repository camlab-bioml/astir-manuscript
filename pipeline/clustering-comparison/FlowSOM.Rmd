---
title: "FlowSOM"
author: "Michael Geuenich"
date: "May 29, 2020"
output: html_document
params:
  markers: "specified_markers"
  cells: "../../output/v4/zurich1_subset/zurich1_subset_sce.rds"
  celltypes: "../../output/v4/zurich1_subset/zurich1_subset_assignments_type.csv"
  cellstates: "../../output/v4/zurich1_subset/zurich1_subset_assignments_state.csv" 
  cohort: "zurich1"
  markers_list: ""
  output_results: ""
  cluster_options: ""
  FlowSOM_seed: NULL
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../../')
library(SingleCellExperiment)
library(tidyverse)
library(devtools)
library(factoextra)
library(scater)
library(dichromat)
library(cytofkit)
library(taproom)
```

First read in all sc data and assign cell type
```{r message=F, warning=F}
# read in data 
sce <- readRDS(params$cells)
```

```{r}
if(params$markers == "all_markers"){
  imc.data <- t(logcounts(sce))

}else if(params$markers == "specified_markers"){
  markers <- read_markers(params$markers_list)
  
  imc.data <- t(logcounts(sce[unique(unlist(markers$cell_types)),]))
  evalStatement <- T
}

if(params$cohort != "basel" & params$cohort != "zurich1"){
  # add a cell ID for schapiro
  sce$id <- colnames(sce)
}
```

```{r}
imc.flowSOM.cluster <- cytof_cluster(xdata = imc.data, method = "FlowSOM",
                                     FlowSOM_k = as.integer(params$cluster_options),
                                     flowSeed = params$FlowSOM_seed)
sce$FlowSOM.k4 <- imc.flowSOM.cluster
```

Write out the files as csvs.
```{r}
flowSOM_k4 <- sce %>% colData() %>% as.data.frame() %>% select(id, "FlowSOM.k4")
rownames(flowSOM_k4) <- c()
flowSOM_k4$method <- "FlowSOM"
flowSOM_k4$params <- paste(params$markers, paste0("k", params$cluster_options), sep = "_")

if(is.null(params$FlowSOM_seed)){
  file_name <- paste0(params$output_results, "FlowSOM_clusters_", params$cohort, "_", params$markers, "_k", params$cluster_options, ".csv")
}else{
  file_name <- paste0(params$output_results, "FlowSOM_clusters_", params$cohort, "_seed-", params$FlowSOM_seed, "_", params$markers, "_k", params$cluster_options, ".csv")
  flowSOM_k4$seed <- params$FlowSOM_seed
}
write.csv(flowSOM_k4, file = file_name,
          col.names = T, row.names = F, sep = ",", quote = FALSE)
```