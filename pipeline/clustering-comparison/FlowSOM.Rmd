---
title: "FlowSOM"
author: "Michael Geuenich"
date: "May 29, 2020"
output: html_document
params:
  markers: "specified_markers"
  create_csv: FALSE
  cells: "../../output/v4/zurich1_subset/zurich1_subset_sce.rds"
  celltypes: "../../output/v4/zurich1_subset/zurich1_subset_assignments_type.csv"
  cellstates: "../../output/v4/zurich1_subset/zurich1_subset_assignments_state.csv" 
  cohort: "zurich1"
  markers_list: ""
  output_results: ""
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/imc-2020/')
library(SingleCellExperiment)
library(tidyverse)
library(devtools)
library(factoextra)
library(ComplexHeatmap)
library(scater)
library(dichromat)
library(viridis)
library(cytofkit)
library(ggalluvial)
devtools::load_all("~/taproom/")
source("~/imc-2020/scripts/functions.R")
```

First read in all sc data and assign cell type
```{r message=F, warning=F}
# read in data 
sce <- readRDS(params$cells)
#type <- read_csv(params$celltypes)

#type$cell_type <- get_celltypes(select(type, -X1), 0.5) 
#type <- select(type, X1, cell_type) %>%
#  column_to_rownames("X1")
#colData(sce)["cell_type"] <- type[colnames(sce),]

# read in data
#sce <- assignIdentity(params$cells, params$celltypes, params$cellstates)
#pathways <- sce$pathways
#sce <- sce$sce

# Just for the time being until we switch everything over to remove s' at the end
#if(params$cohort != "wagner"){
#  sce$cell_type[which(sce$cell_type == "B cell")] <- "B cells"
#}
#sce$cell_type[which(sce$cell_type == "T cell")] <- "T cells"
```

```{r}
if(params$markers == "all_markers"){
  imc.data <- t(logcounts(sce))
  
  # I will use this variable in the future to evaluate whether sections of code
  # should be executed
  evalStatement <- F
}else if(params$markers == "specified_markers"){
  markers <- read_markers(params$markers_list)
  
  imc.data <- t(logcounts(sce[unique(unlist(markers$cell_types)),]))
  evalStatement <- T
}

if(params$cohort != "basel" & params$cohort != "zurich1"){
  # add a cell ID for schapiro
  sce$id <- colnames(sce)
}
```

```{r}
# FlowSOM - just going with the number of cell types for now
imc.flowSOM.cluster <- cytof_cluster(xdata = imc.data, method = "FlowSOM",
                                     FlowSOM_k = 4)
sce$FlowSOM.k4 <- imc.flowSOM.cluster

imc.flowSOM.cluster <- cytof_cluster(xdata = imc.data, method = "FlowSOM",
                                     FlowSOM_k = 7)
sce$FlowSOM.k7 <- imc.flowSOM.cluster

imc.flowSOM.cluster <- cytof_cluster(xdata = imc.data, method = "FlowSOM",
                                     FlowSOM_k = 8)
sce$FlowSOM.k8 <- imc.flowSOM.cluster

#K 12
imc.flowSOM.cluster <- cytof_cluster(xdata = imc.data, method = "FlowSOM",
                                     FlowSOM_k = 12)
sce$FlowSOM.k12 <- imc.flowSOM.cluster


# K15
imc.flowSOM.cluster <- cytof_cluster(xdata = imc.data, method = "FlowSOM",
                                     FlowSOM_k = 15)
sce$FlowSOM.k15 <- imc.flowSOM.cluster


#K 20
imc.flowSOM.cluster <- cytof_cluster(xdata = imc.data, method = "FlowSOM",
                                     FlowSOM_k = 20)
sce$FlowSOM.k20 <- imc.flowSOM.cluster
```

Write out the files as csv's.
```{r eval=params$create_csv}
flowSOM_k4 <- sce %>% colData() %>% as.data.frame() %>% select(id, "FlowSOM.k4")
rownames(flowSOM_k4) <- c()
flowSOM_k4$method <- "FlowSOM"
flowSOM_k4$params <- paste(params$markers, "k4", sep = "_")
write.csv(flowSOM_k4, file = paste0(params$output_results, "FlowSOM_clusters_", 
                                    params$cohort, "_", params$markers, "_k4.csv"),
          col.names = T, row.names = F, sep = ",")

flowSOM_k7 <- sce %>% colData() %>% as.data.frame() %>% select(id, "FlowSOM.k7")
rownames(flowSOM_k7) <- c()
flowSOM_k7$method <- "FlowSOM"
flowSOM_k7$params <- paste(params$markers, "k7", sep = "_")
write.csv(flowSOM_k7, file = paste0(params$output_results, "FlowSOM_clusters_", 
                                    params$cohort, "_", params$markers, "_k7.csv"),
          col.names = T, row.names = F, sep = ",")


flowSOM_k8 <- sce %>% colData() %>% as.data.frame() %>% select(id, "FlowSOM.k8")
rownames(flowSOM_k8) <- c()
flowSOM_k8$method <- "FlowSOM"
flowSOM_k8$params <- paste(params$markers, "k8", sep = "_")
write.csv(flowSOM_k8, file = paste0(params$output_results, "FlowSOM_clusters_", 
                                    params$cohort, "_", params$markers, "_k8.csv"),
          col.names = T, row.names = F, sep = ",")


flowSOM_k8 <- sce %>% colData() %>% as.data.frame() %>% select(id, "FlowSOM.k12")
rownames(flowSOM_k8) <- c()
flowSOM_k8$method <- "FlowSOM"
flowSOM_k8$params <- paste(params$markers, "k12", sep = "_")
write.csv(flowSOM_k8, file = paste0(params$output_results, "FlowSOM_clusters_",
                                    params$cohort, "_", params$markers, "_k12.csv"),
          col.names = T, row.names = F, sep = ",")


flowSOM_k8 <- sce %>% colData() %>% as.data.frame() %>% select(id, "FlowSOM.k15")
rownames(flowSOM_k8) <- c()
flowSOM_k8$method <- "FlowSOM"
flowSOM_k8$params <- paste(params$markers, "k15", sep = "_")
write.csv(flowSOM_k8, file = paste0(params$output_results, "FlowSOM_clusters_", 
                                    params$cohort, "_", params$markers, "_k15.csv"),
          col.names = T, row.names = F, sep = ",")


flowSOM_k8 <- sce %>% colData() %>% as.data.frame() %>% select(id, "FlowSOM.k20")
rownames(flowSOM_k8) <- c()
flowSOM_k8$method <- "FlowSOM"
flowSOM_k8$params <- paste(params$markers, "k20", sep = "_")
write.csv(flowSOM_k8, file = paste0(params$output_results, "FlowSOM_clusters_", 
                                    params$cohort, "_", params$markers, "_k20.csv"),
          col.names = T, row.names = F, sep = ",")

```