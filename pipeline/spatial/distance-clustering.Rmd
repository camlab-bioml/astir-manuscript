---
title: "Distance clustering"
output: html_document
params:
  input_dir: "../../output/chipmunk/spatial/basel/"
  metadata: "../..//data-raw/jackson-2020/SingleCell_and_Metadata/BaselTMA/Basel_PatientMetadata.csv"
  dataset: "basel"
  celltype_assignments: "../../output/chipmunk/astir_assignments/basel_astir_assignments.csv"
  df_test: "test.csv"
  scree_plot: "../../figures/supplementary/scree-plot-spatial-basel.png"
  output_rds: "../../output/chipmunk/spatial/basel/basel_output.rds"
---

```{r setup, include=FALSE}
library(tidyverse)
library(ComplexHeatmap)
library(viridis)
library(broom)
library(survival)
library(glue)
library(DelayedArray)
# library(survminer)

devtools::load_all("../taproom")
```

# Compute cell type entropy

```{r}
assignments <- read_csv(params$celltype_assignments)
cell_names <- assignments$X1
assignments$X1 <- NULL
df_cell_types <- tibble(
  id = cell_names,
  cell_type = get_celltypes(assignments)
)
```

```{r}
df <- df_cell_types

df$core <- sapply(
  strsplit(df_cell_types$id, "_"), 
  function(s) {
    paste0(s[1:4], collapse="_")
  }
)

df$cell_type <- as.factor(df$cell_type)
```

```{r}
entropy <- function(s) {
  p <- prop.table(table(s))
  e <- p * log2(p)
  e[is.na(e)] <- 0
  -sum(e)
}

df_entropy <- group_by(df, core) %>% 
  summarize(entropy = entropy(cell_type))
```

```{r}
df_entropy <- mutate(df_entropy,
                     entropy_weight = (entropy - min(entropy))/ (max(entropy) - min(entropy)))
```

```{r}
entropy_weights <- df_entropy$entropy_weight
names(entropy_weights) <- df_entropy$core
```

```{r}
cutoff <- quantile(df_entropy$entropy_weight, 0.05)
cores_to_keep <- df_entropy$core[df_entropy$entropy_weight > cutoff]
```


# Everything else


```{r}
csv_files <- dir(params$input_dir, full.names = TRUE)
```

```{r}
ct <- cols(
  core = col_character(),
  Celltype_1 = col_character(),
  Celltype_2 = col_character(),
  avg_distance = col_double(),
  n_cells = col_double()
)

df <- map_dfr(csv_files, read_csv, col_types = ct)
```

```{r}
df <- filter(df,
        # Celltype_1 != Celltype_2,
        # grepl("luminal|T|Stromal|Macrophage", Celltype_1),
        # grepl("luminal|T|Stromal|Macrophage", Celltype_2),
       # grepl("luminal|T|Macrophage|Stromal", Celltype_1),
       # grepl("luminal|T|Macrophage|Stromal", Celltype_2),
       # !grepl("basal|other", Celltype_1),
       # !grepl("basal|other", Celltype_2),
       core %in% cores_to_keep)

```


```{r}
df$ct_string <- paste0(df$Celltype_1, " - ", df$Celltype_2)
```

```{r}
df_wide <- select(df, -Celltype_1, -Celltype_2) %>% 
  spread(ct_string, avg_distance)
```

```{r}
mat <- select(df_wide, -(core:n_cells)) %>% 
  as.matrix()
rownames(mat) <- df_wide$core

# mat <- mat[rowMeans(is.na(mat)) < 0.5, ]
# mat <- mat[, colMeans(is.na(mat)) < 0.5]

mat <- scale(mat)
# mat[mat > 2] <- 2
# mat[mat < -2] <- -2
```

```{r}
cell_nums <- select(df, core, n_cells) %>% 
  distinct()
cell_num_vec <- cell_nums$n_cells
names(cell_num_vec) <- cell_nums$core
cell_num_vec <- cell_num_vec[rownames(mat)]
```

```{r}
cell_num_vec <- cell_num_vec[cell_num_vec > 1500]
mat <- mat[names(cell_num_vec),]
```




```{r}
mdata <- read_csv(params$metadata)
```

```{r}
status <- mdata$diseasestatus
names(status) <- mdata$core
```

```{r}
mat2 <- apply(mat, 1, function(x) {
  x[is.na(x)] <- mean(x, na.rm = T)
  x
}) %>% 
  t()
```


```{r}
pca <- prcomp(mat2)
spatial_score <- pca$x[,1]
```

```{r}
correlations <- apply(mat2, 2, cor, spatial_score)
if(mean(correlations) < 0) {
  spatial_score <- -spatial_score
}
```
```


```{r}
tibble(
  `Variance explained` = pca$sdev^2,
  Component = seq_along(pca$sdev)
) %>% 
  ggplot(aes(x = Component, y = `Variance explained`)) +
  geom_bar(stat='identity') +
  astir_paper_theme() +
  scale_x_continuous(breaks=seq_along(pca$sdev))

ggsave(params$scree_plot, width = 4, height = 3)
```


```{r}
```




```{r}



top_annot <- HeatmapAnnotation(`# cells` = anno_barplot(cell_num_vec),
                               `Spatial score` = spatial_score * entropy_weights[names(spatial_score)])

ht <- Heatmap(t(mat2), na_col = "grey90", show_column_names = FALSE, col=viridis(100),
              top_annotation = top_annot)
draw(ht)
```

```{r}
spatial_level <- pca$x[,1] > median(pca$x[,1])
```



# Associate with states


```{r, eval=FALSE}
state_assignments <- read_csv(params$state_assignments)
```

```{r, eval=FALSE}
celltype_assignments <- read_csv(params$celltype_assignments)
```

```{r, eval=FALSE}

cell_names <- celltype_assignments$X1
celltype_assignments$X1 <- NULL
cell_types <- get_celltypes(celltype_assignments)
cell_types <- tibble(X1 = cell_names, cell_type = cell_types)
```

```{r, eval=FALSE}
s <- inner_join(state_assignments, cell_types, by = "X1") %>% 
  filter(cell_type != "Unknown", cell_type != "Other")
```


```{r, eval=FALSE}
cores <- s$X1
cores <- strsplit(cores, "_", fixed=TRUE)
cores <- lapply(cores, `[`, 1:4)
cores <- sapply(cores, paste0, collapse="_")
s$core <- cores
```

```{r, eval=FALSE}
s <- gather(s, state, activation, -X1, -core, -cell_type) %>% 
  group_by(cell_type, state) %>% 
  mutate(activation = activation - mean(activation)) %>% 
  ungroup()
```


```{r, eval=FALSE}
ggplot(s, aes(x = cell_type, y = activation)) +
  facet_wrap(~ state) +
  geom_boxplot()
```



```{r, eval=FALSE}
df_state <- group_by(s, core, state) %>% 
  summarize(activation = mean(activation)) %>% 
  ungroup()
```


```{r, eval=FALSE}
df_state <- enframe(spatial_score, "core", "spatial_score") %>% 
  inner_join(df_state, by = "core")
```


```{r, eval=FALSE}
df_test <- group_by(df_state, state) %>% 
  do(tidy(lm(activation ~ spatial_score, data = .))) %>% 
  filter(term == "spatial_score") %>% 
  mutate(dataset = params$dataset)
```

```{r, eval=FALSE}
DT::datatable(df_test)
```


```{r, eval=FALSE}
ggplot(df_state, aes(x = spatial_score, y = activation)) +
  geom_point() +
  facet_wrap(~ state, scales = "free_y") +
  geom_smooth(method="lm")
```



```{r}
save_rds <- list(
  cell_num_vec = cell_num_vec,
  spatial_score = spatial_score, 
  mat = mat2,
  # df_state = df_state,
  # df_test = df_test,
  entropy_weights = entropy_weights
)

saveRDS(save_rds, file = params$output_rds)
```


