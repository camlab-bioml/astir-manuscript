---
title: "ClusterX different cell type proportions"
author: "Michael Geuenich"
date: "November 24, 2020"
output: html_document
params:
  markers: "all_markers"
  cells: "output/chipmunk/sces/wagner_sce.rds"
  cellSubset: "output/chipmunk/results/epithelial_overclustering/luminal_20.csv" 
  markers_list: ""
  output_results: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '.')
library(tidyverse)
library(SingleCellExperiment)
library(cytofkit)
```


```{r}
cell_subset <- read_csv(params$cellSubset)

sce <- readRDS(params$cells)[,cell_subset$cell_id]

percent_luminal <- str_split(params$cellSubset, "luminal_")[[1]][2]
percent_luminal <- str_split(percent_luminal, ".csv")[[1]][1]
```


Clustering
```{r}
if(params$markers == "all_markers"){
  imc.data <- t(logcounts(sce))
}else if(params$markers == "specified_markers"){
  markers <- read_markers(params$markers_list)
  
  imc.data <- t(logcounts(sce[unique(unlist(markers$cell_types)),]))
}

imc.tsne <- cytof_dimReduction(data=imc.data, method = "tsne")
imc.clusterX.cluster <- cytof_cluster(ydata = imc.tsne, method = "ClusterX")

sce$clusterX <- imc.clusterX.cluster
```


```{r}
ClusterX <- sce %>% 
  colData() %>% 
  as.data.frame() %>% 
  rownames_to_column("id") %>% 
  select(id, "clusterX")

ClusterX$method <- "ClusterX"
ClusterX$params <- paste(params$markers, "Default", sep = "_")
ClusterX$percent_epithelial <- percent_luminal
write.csv(ClusterX, file = paste0(params$output_results, 
                                  "Epithelial_overclustering_ClusterX_clusters-",
                                  params$markers, "-default-", percent_luminal, ".csv"),
          col.names = T, row.names = F, sep = ",")

```